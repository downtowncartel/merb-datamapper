h1. Chapter 4 - Red Green Refactor

h2. Model Specs

h4. app

<pre>
<code class="ruby">
  merb+datamapper $ ls community_shelf/app/
  controllers	helpers		models		views
</code>
</pre>

h4. app/models

<pre>
<code class="ruby">
  merb+datamapper $ ls community_shelf/app/models/
  book.rb		reservation.rb	user.rb
</code>
</pre>

h4. app/models/book.rb

<pre>
<code class="ruby">
class Book
  include DataMapper::Resource

  property :id,               Serial
  property :isbn,             String,   :length => 13,  :nullable => false
  property :created_at,       DateTime,                 :nullable => false
  property :short_title,      String,   :length => 50
  property :long_title,       String,   :length => 200
  property :author,           String,   :length => 200
  property :publisher,        String,   :length => 200
  property :notes,            Text
  property :owner_id,         Integer


  is :permalink, :title, :length => 60


  belongs_to :owner, :class_name => "User"
  has n, :reservations


  validates_present :title, :owner


  def title
    @short_title.blank? ? @long_title : @short_title
  end
end
</code>
</pre>

h4. spec/models/book_spec.rb

<pre>
<code clas="ruby">
require File.join( File.dirname(__FILE__), '..', "spec_helper" )

describe Book do

  before(:each) do
    DataMapper.auto_migrate!
  end

  describe "#title" do
    it "should not be blank unless both the short & long titles are blank" do
      book = Book.new(:short_title => "short", :long_title => "long")
      book.title.should_not be_blank

      book.short_title = book.long_title = ""
      book.title.should be_blank
    end

    #....
  end

  describe "Validations" do
    it "should validate the short_title or long_title is present through the title presence validation" do
      book = Book.new(:short_title => nil, :long_title => nil)

      book.should_not be_valid
      book.errors[:title].should_not be_nil
      book.errors[:title].should_not be_empty
    end
  end
end
</code>
</pre>



h3. Running the Model Specs

<pre>
<code class="sh">
  community_shelf $ rake spec:model
  (in /Users/ben/code/merb+datamapper/community_shelf)
  ....

  Finished in 0.111621 seconds

  4 examples, 0 failures
</code>
</pre>

h2. Controller Specs

h4. app/controllers

<pre>
<code class="ruby">
  community_shelf $ ls app/controllers/
  application.rb	books.rb	exceptions.rb
</code>
</pre>

h4. app/controllers/books.rb

<pre>
<code class="ruby">
class Books < Application

  # ...and remember, everything returned from an action
  # goes to the client...
  def index
    render
  end

  def show(slug)
    @book = Book.first(:slug => slug) || raise(NotFound, :book_slug => slug)

    display @book
  end
end
</code>
</pre>

h4. spec/controllers/books.rb

<pre>
<code class="ruby">
require File.join(File.dirname(__FILE__), '..', 'spec_helper.rb')

describe Books, "index action" do
  before(:each) do
    dispatch_to(Books, :index)
  end
end

describe Books, "show action" do
  it "should find the first book that matches the slug, and display the book" do
    book = mock(:book)
    Book.should_receive(:first).with(:slug => "pragprog").and_return book

    dispatch_to(Books, :show, :slug => "pragprog") do |controller|
      controller.should_receive(:display).with(book)
    end
  end

  it "should raise a NotFound exception if the slug parameter does not match a book" do
    Book.should_receive(:first).and_return nil

    lambda {
      dispatch_to(Books, :show, :slug => "pragprog")

    }.should raise_error(Merb::ControllerExceptions::NotFound, :book_slug => "pragprog")
  end
end
</code>
</pre>

h3. Running the Controller Specs

<pre>
<code class="sh">
  community_shelf $ rake spec:controller
  (in /Users/ben/code/merb+datamapper/community_shelf)
  ..

  Finished in 0.089664 seconds

  2 examples, 0 failures
</code>
</pre>

h2. View Specs

h4. app/views/books/show.html.haml

<pre>
<code class="ruby">
.span-18.postpend-6.last
  %h2
    =@book.title
  .span-10.prepend-2.postpend-6.last
    %h3.author
      %span.alt By
      =@book.author
  .span-6
    %h4
      %span.alt Owner
  .span-6
    %h4
      %span.alt ISBN
  .span-6.last
    %h4
      %span.alt Publisher
  .span-6
    %h4
      =@book.owner.name
  .span-6
    %h4
      =@book.isbn
  .span-6.last
    %h4
      =@book.publisher
  .span-18.last
    %h3.alt Notes
  .span-12.prepend-3.postpend-3
    =@book.notes
</code>
</pre>

h4. spec/views/books/show_html_spec.rb

<pre>
<code>
require File.join(File.dirname(__FILE__), '..', '..', 'spec_helper.rb')

describe "posts/show.html" do
  before(:each) do
    DataMapper.auto_migrate!
    @book = Book.gen(:owner => User.gen)

    @response = dispatch_to(Books, :show, :slug => @book.slug)
  end

  it "should display the title inside an h2" do
    @response.body.should have_tag(:h2) {|h2| h2.should contain(@book.title)}
  end

  it "should display the author inside an author h3" do
    @response.body.should have_tag(:h3, :class => :author) {|h3| h3.should contain(@book.author)}
  end

  it "should display the ISBN within an h4 inside a div of span 6" do
    @response.body.should have_selector("div.span-6 h4") {|h4| h4.should contain(@book.isbn)}
  end
end
</code>
</pre>

